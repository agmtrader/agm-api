name: Daily Pending Tasks & Leads Summary

on:
  schedule:
    # Every day at 3 PM UTC (9:00 AM CST)
    - cron: '0 15 * * *'
  workflow_dispatch:

jobs:
  fetch-summary:
    runs-on: ubuntu-latest
    outputs:
      tasks: ${{ steps.fetch.outputs.pending_tasks_md }}
      leads: ${{ steps.fetch.outputs.leads_md }}
    steps:
      - name: Request token and fetch tasks/leads
        id: fetch
        uses: Wandalen/wretry.action@v2
        with:
          command: |
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 1. Fetch access token (same mechanism as ETL / other jobs)
            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -d '{"token":"all"}' \
              https://api.agmtechnology.com/token)

            http_status=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            if [ "$http_status" != "200" ]; then
              echo "Token request failed with status $http_status" >&2
              exit 1
            fi

            access_token=$(echo "$body" | jq -r '.access_token')
            if [ "$access_token" = "null" ] || [ -z "$access_token" ]; then
              echo "access_token not found in response" >&2
              exit 1
            fi

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 2. Fetch Pending Tasks
            response=$(curl -s -w "\n%{http_code}" -X GET \
              -H "Authorization: Bearer $access_token" \
              https://api.agmtechnology.com/pending_tasks/read)
            http_status=$(echo "$response" | tail -n1)
            tasks_body=$(echo "$response" | sed '$d')
            if [ "$http_status" != "200" ]; then
              echo "Fetching pending tasks failed with status $http_status" >&2
              exit 1
            fi

            # Extract markdown list of pending tasks (id and title if present)
            pending_tasks_md=$(echo "$tasks_body" | jq -r '.pending_tasks[] | "- [" + (.id // "n/a") + "] " + (.title // .task // "Unnamed Task")')
            if [ -z "$pending_tasks_md" ]; then
              pending_tasks_md="No pending tasks found."
            fi

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 3. Fetch Leads
            response=$(curl -s -w "\n%{http_code}" -X GET \
              -H "Authorization: Bearer $access_token" \
              https://api.agmtechnology.com/leads/read)
            http_status=$(echo "$response" | tail -n1)
            leads_body=$(echo "$response" | sed '$d')
            if [ "$http_status" != "200" ]; then
              echo "Fetching leads failed with status $http_status" >&2
              exit 1
            fi

            leads_md=$(echo "$leads_body" | jq -r '.leads[] | "- [" + (.id // "n/a") + "] " + (.name // .email // "Unnamed Lead")')
            if [ -z "$leads_md" ]; then
              leads_md="No leads found."
            fi

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 4. Pass markdown lists to next job via step outputs
            printf "pending_tasks_md<<EOF\n%s\nEOF\n" "$pending_tasks_md" >> "$GITHUB_OUTPUT"
            printf "leads_md<<EOF\n%s\nEOF\n" "$leads_md" >> "$GITHUB_OUTPUT"
          attempt_limit: 24     # Retry up to 24 times (10-min interval) like other jobs
          attempt_delay: 600000 # 10-minute pause (ms)

  notify:
    needs: fetch-summary
    runs-on: ubuntu-latest
    if: ${{ success() }}
    steps:
      - name: Compose HTML email body
        run: |
          SUMMARY_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          # Decode %0A into real newlines for tasks and leads
          TASKS=$(echo "${{ needs.fetch-summary.outputs.tasks }}" | sed 's/%0A/\n/g')
          LEADS=$(echo "${{ needs.fetch-summary.outputs.leads }}" | sed 's/%0A/\n/g')
          # Convert "- item" markdown to <ul><li> list
          list_to_html() {
            local input="$1"
            if [ -z "$input" ] || [ "$input" = "No pending tasks found." ] || [ "$input" = "No leads found." ]; then
              echo "<p><em>$input</em></p>"
              return
            fi
            echo "<ul>";
            while IFS= read -r line; do
              trimmed="${line#*- }"  # remove leading '- '
              echo "  <li>$trimmed</li>";
            done <<< "$input"
            echo "</ul>";
          }

          TASKS_HTML=$(list_to_html "$TASKS")
          LEADS_HTML=$(list_to_html "$LEADS")

          {
            echo "<!DOCTYPE html>"
            echo "<html lang=\"en\">"
            echo "<head><meta charset=\"UTF-8\"><title>Daily Summary</title></head>"
            echo "<body style=\"font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;line-height:1.6;color:#2D3748;\">"
            echo "<div style=\"max-width:600px;margin:40px auto;padding:40px;background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.05);\">"
            echo "<h1 style=\"text-align:center;color:#1A365D;\">Daily Summary ($SUMMARY_DATE)</h1>"
            echo "<h2 style=\"color:#1A365D;\">Pending Tasks</h2>"
            echo "$TASKS_HTML"
            echo "<h2 style=\"color:#1A365D;\">Leads</h2>"
            echo "$LEADS_HTML"
            echo "<p>Have a great day!</p>"
            echo "</div></body></html>"
          } > email_body.html

      - name: Send daily summary email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸ“¬ Daily Pending Tasks & Leads Summary"
          to: aa@agmtechnology.com,cr@agmtechnology.com
          from: aa@agmtechnology.com
          html_body: file://email_body.html

  notify-failure:
    needs: fetch-summary
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    steps:
      - name: Send failure email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸš¨ Daily Summary Workflow FAILED"
          to: aa@agmtechnology.com,cr@agmtechnology.com
          from: aa@agmtechnology.com
          body: |
            The daily pending tasks and leads summary workflow failed. Please review the workflow logs for details.
