name: Daily ETL Pipeline

on:
  schedule:
    - cron: '30 13 * * *'   # Every day at 1 PM UTC (7:00 AM CST)
  workflow_dispatch:

jobs:
  etl:
    runs-on: ubuntu-latest

    steps:
      # 1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Request access token
        id: token
        uses: Wandalen/wretry.action@v2
        with:
          command: |
            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -d '{"token":"${{ secrets.AUTHENTICATION_TOKEN }}","scopes":"all"}' \
              https://api.agmtechnology.com/token)

            http_status=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            echo "http_status=$http_status" >> "$GITHUB_OUTPUT"
            echo "body=$body"               >> "$GITHUB_OUTPUT"

            if [ "$http_status" != "200" ]; then
              echo "Token request failed with status $http_status"
              exit 1
            fi

            access_token=$(echo "$body" | jq -r '.access_token')
            if [ "$access_token" = "null" ] || [ -z "$access_token" ]; then
              echo "access_token not found in response"
              exit 1
            fi
            echo "access_token=$access_token" >> "$GITHUB_OUTPUT"
          retry_count: 1         # total attempts = 1 original + 1 retry
          retry_delay: 5000     # 5-second wait between attempts (milliseconds)
          retry_on: error

      # 2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Trigger reporting run
        id: reporting
        uses: Wandalen/wretry.action@v2
        with:
          command: |
            status=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer ${{ steps.token.outputs.access_token }}" \
              -X GET https://api.agmtechnology.com/reporting/run)

            echo "http_status=$status" >> "$GITHUB_OUTPUT"

            if [ "$status" != "200" ]; then
              echo "Reporting run request failed with status $status"
              exit 1
            fi
          retry_count: 9 # total attempts = 1 original + 9 retries
          retry_delay: 600000 # 10-minute wait between attempts (milliseconds)
          retry_on: error

      # 3 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Summarise results
        run: |
          {
            echo "## ETL summary :clipboard:"
            echo ""
            echo "| Action | HTTP status |"
            echo "| ------ | ----------- |"
            echo "| Token request   | \`${{ steps.token.outputs.http_status }}\` |"
            echo "| Reporting run   | \`${{ steps.reporting.outputs.http_status }}\` |"
          } >> "$GITHUB_STEP_SUMMARY"

  notify-success:
    needs: etl
    if: ${{ success() }}
    runs-on: ubuntu-latest
    steps:
      - name: Send success email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ Daily ETL Pipeline SUCCEEDED"
          to: aa@agmtechnology.com
          from: aa@agmtechnology.com
          body: |
            The Daily ETL Pipeline workflow completed successfully üéâ

            Repo: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  notify-failure:
    needs: etl
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    steps:
      - name: Send failure email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üö® Daily ETL Pipeline FAILED"
          to: aa@agmtechnology.com
          from: aa@agmtechnology.com
          body: |
            The Daily ETL Pipeline workflow failed ‚ùå

            Repo: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
